# SPDX-License-Identifier: CPAL-1.0
# Copyright (c) 2026 Aryan Ameri

# Phase 0 — Ensure SDN bridges are active

- name: Source interfaces.d in network config
  ansible.builtin.lineinfile:
    path: /etc/network/interfaces
    line: "source /etc/network/interfaces.d/*"
    insertafter: EOF
  when: proxmox_lxc_config_sdn_bridges | length > 0
  notify: Reload networking

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Check SDN bridge status
  ansible.builtin.command:
    cmd: "ip link show {{ item }}"
  register: _proxmox_lxc_config_bridge_check
  changed_when: false
  failed_when: false
  loop: "{{ proxmox_lxc_config_sdn_bridges }}"
  loop_control:
    label: "{{ item }}"
  when: proxmox_lxc_config_sdn_bridges | length > 0

- name: Reload networking to activate SDN bridges
  ansible.builtin.command:
    cmd: ifreload -a
  changed_when: true
  when:
    - proxmox_lxc_config_sdn_bridges | length > 0
    - _proxmox_lxc_config_bridge_check.results | selectattr('rc', 'ne', 0) | list | length > 0

# Phase 1 — Host subuid/subgid for container idmaps

- name: Set host subuid range for root
  ansible.builtin.lineinfile:
    path: /etc/subuid
    regexp: '^root:'
    line: "root:{{ proxmox_lxc_config_subuid_start }}:{{ proxmox_lxc_config_subuid_count }}"
    create: true
    mode: "0644"

- name: Set host subgid range for root
  ansible.builtin.lineinfile:
    path: /etc/subgid
    regexp: '^root:'
    line: "root:{{ proxmox_lxc_config_subuid_start }}:{{ proxmox_lxc_config_subuid_count }}"
    create: true
    mode: "0644"

# Phase 2 — DNAT nftables rules for container port forwarding

- name: Write container DNAT nftables rules
  ansible.builtin.template:
    src: nftables-container-dnat.conf.j2
    dest: /etc/nftables-container-dnat.conf
    mode: "0644"
    validate: "nft -c -f %s"
  notify: Reload container DNAT rules

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

# Phase 3 — Container idmaps (bpg provider v0.96.0 does not support idmap blocks)

- name: Configure container idmaps
  ansible.builtin.shell:
    cmd: |
      set -euo pipefail
      conf="/etc/pve/lxc/{{ item.vmid }}.conf"
      changed=false
      {% for idmap in item.idmaps %}
      if ! grep -qxF 'lxc.idmap: {{ idmap }}' "$conf"; then
        changed=true
      fi
      {% endfor %}
      if [ "$changed" = "true" ]; then
        sed -i '/^lxc\.idmap:/d' "$conf"
        {% for idmap in item.idmaps %}
        echo 'lxc.idmap: {{ idmap }}' >> "$conf"
        {% endfor %}
        echo "CHANGED"
      else
        echo "OK"
      fi
    executable: /bin/bash
  register: _proxmox_lxc_config_idmap
  changed_when: "'CHANGED' in _proxmox_lxc_config_idmap.stdout"
  loop: "{{ proxmox_lxc_config_containers | selectattr('idmaps', 'defined') | list }}"
  loop_control:
    label: "{{ item.vmid }}"

# Phase 3b — Feature flags that API tokens cannot set

- name: Read current container config
  ansible.builtin.command:
    cmd: "pct config {{ item.vmid }}"
  register: _proxmox_lxc_config_pct
  changed_when: false
  loop: "{{ proxmox_lxc_config_containers | selectattr('features', 'defined') | list }}"
  loop_control:
    label: "{{ item.vmid }}"

- name: Set container feature flags
  ansible.builtin.command:
    cmd: "pct set {{ item.item.vmid }} --features {{ item.item.features }}"
  register: _proxmox_lxc_config_features
  changed_when: _proxmox_lxc_config_features.rc == 0
  vars:
    _current: >-
      {{ item.stdout_lines | select('match', '^features:')
         | first | default('features:')
         | regex_replace('^features:\s*', '')
         | split(',') | sort | join(',') }}
    _desired: >-
      {{ item.item.features | split(',') | sort | join(',') }}
  when: _current != _desired
  loop: "{{ _proxmox_lxc_config_pct.results }}"
  loop_control:
    label: "{{ item.item.vmid }}"

# Phase 3c — TUN device passthrough (required for rootless Podman pasta networking)

- name: Configure TUN device passthrough
  ansible.builtin.shell:
    cmd: |
      set -euo pipefail
      conf="/etc/pve/lxc/{{ item.vmid }}.conf"
      changed=false
      if ! grep -qxF 'lxc.cgroup2.devices.allow: c 10:200 rwm' "$conf"; then
        changed=true
      fi
      if ! grep -qxF 'lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file' "$conf"; then
        changed=true
      fi
      if [ "$changed" = "true" ]; then
        sed -i '/^lxc\.cgroup2\.devices\.allow: c 10:200/d' "$conf"
        sed -i '/^lxc\.mount\.entry:.*\/dev\/net\/tun/d' "$conf"
        echo 'lxc.cgroup2.devices.allow: c 10:200 rwm' >> "$conf"
        echo 'lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file' >> "$conf"
        echo "CHANGED"
      else
        echo "OK"
      fi
    executable: /bin/bash
  register: _proxmox_lxc_config_tun
  changed_when: "'CHANGED' in _proxmox_lxc_config_tun.stdout"
  loop: "{{ proxmox_lxc_config_containers | selectattr('tun', 'defined') | selectattr('tun') | list }}"
  loop_control:
    label: "{{ item.vmid }}"

# Phase 3d — Restart containers whose config changed (features/idmaps/tun need reboot)

- name: Collect containers needing restart
  ansible.builtin.set_fact:
    _proxmox_lxc_config_restart_vmids: >-
      {{ (_proxmox_lxc_config_idmap.results
          | selectattr('changed')
          | map(attribute='item.vmid')
          | list)
         +
         (_proxmox_lxc_config_features.results
          | selectattr('changed')
          | map(attribute='item.item.vmid')
          | list)
         +
         (_proxmox_lxc_config_tun.results
          | selectattr('changed')
          | map(attribute='item.vmid')
          | list)
         | unique }}

- name: Stop containers whose config changed
  ansible.builtin.command:
    cmd: "pct stop {{ item }}"
  register: _proxmox_lxc_config_config_stop
  changed_when: _proxmox_lxc_config_config_stop.rc == 0
  failed_when: false
  loop: "{{ _proxmox_lxc_config_restart_vmids }}"
  loop_control:
    label: "{{ item }}"

# Phase 3d — Restart containers with broken internal networking
# PVE writes /etc/network/interfaces inside the container on start.
# If a running container has DOWN interfaces (e.g. after ostype change
# from "unmanaged" to "debian"), stop it so Phase 4 restarts it.

- name: Check internal networking on running containers
  ansible.builtin.shell:
    cmd: |
      set -euo pipefail
      status=$(pct status {{ item.vmid }})
      if echo "$status" | grep -q running; then
        eth0_info=$(pct exec {{ item.vmid }} -- ip -br addr show eth0 2>&1) || true
        if echo "$eth0_info" | grep -q "does not exist"; then
          echo "NO_ETH0"
        elif echo "$eth0_info" | grep -q UP; then
          echo "OK"
        else
          pct stop {{ item.vmid }}
          echo "STOPPED"
        fi
      else
        echo "NOT_RUNNING"
      fi
    executable: /bin/bash
  register: _proxmox_lxc_config_net_health
  changed_when: "'STOPPED' in _proxmox_lxc_config_net_health.stdout"
  failed_when: _proxmox_lxc_config_net_health.rc != 0
  loop: "{{ proxmox_lxc_config_containers }}"
  loop_control:
    label: "{{ item.vmid }}"

# Phase 4 — Start containers

- name: Check container status
  ansible.builtin.command:
    cmd: "pct status {{ item.vmid }}"
  register: _proxmox_lxc_config_status
  changed_when: false
  loop: "{{ proxmox_lxc_config_containers }}"
  loop_control:
    label: "{{ item.vmid }}"

- name: Start stopped containers
  ansible.builtin.command:
    cmd: "pct start {{ item.item.vmid }}"
  changed_when: true
  when: "'running' not in item.stdout"
  loop: "{{ _proxmox_lxc_config_status.results }}"
  loop_control:
    label: "{{ item.item.vmid }}"
