# SPDX-License-Identifier: CPAL-1.0
# Copyright (c) 2026 Aryan Ameri

# Phase 1: Generate + persist (only when not already in SOPS)

- name: Determine if root password is already persisted
  ansible.builtin.set_fact:
    _proxmox_base_root_password_persisted: >-
      {{ proxmox_root_password is defined }}

- name: Check SOPS config exists
  ansible.builtin.stat:
    path: "{{ playbook_dir | dirname }}/.sops.yaml"
  delegate_to: localhost
  become: false
  run_once: true
  register: _proxmox_base_sops_config_stat_rp
  when: not (_proxmox_base_root_password_persisted | bool)

- name: Fail if SOPS config is missing
  ansible.builtin.fail:
    msg: >-
      SOPS config '.sops.yaml' not found at repo root.
      Copy .sops.yaml.example to .sops.yaml and set your age public key.
      See README.md for setup instructions.
  when:
    - not (_proxmox_base_root_password_persisted | bool)
    - not _proxmox_base_sops_config_stat_rp.stat.exists

- name: Generate random root password
  ansible.builtin.set_fact:
    _proxmox_base_root_password_value: >-
      {{ lookup('ansible.builtin.password', '/dev/null chars=ascii_letters,digits length='
         ~ proxmox_base_root_password_length) }}
  when: not (_proxmox_base_root_password_persisted | bool)
  no_log: true

- name: Compute password hash
  ansible.builtin.set_fact:
    _proxmox_base_root_password_hash_value: >-
      {{ _proxmox_base_root_password_value | password_hash('sha512') }}
  when: _proxmox_base_root_password_value is defined
  no_log: true

- name: Persist root password to encrypted secrets file
  when: _proxmox_base_root_password_value is defined
  no_log: true
  block:
    - name: Merge root password into existing secrets file
      community.sops.sops_encrypt:
        path: "{{ playbook_dir | dirname }}/inventory/group_vars/proxmox/secrets.sops.yaml"
        content_yaml: >-
          {{ lookup('community.sops.sops',
             playbook_dir ~ '/../inventory/group_vars/proxmox/secrets.sops.yaml')
             | from_yaml
             | combine({
               'proxmox_root_password': _proxmox_base_root_password_value,
               'proxmox_root_password_hash': _proxmox_base_root_password_hash_value
             }) }}
        force: true
      delegate_to: localhost
      become: false
      run_once: true

    - name: Confirm root password persisted
      ansible.builtin.debug:
        msg: >-
          Root password generated and encrypted in
          inventory/group_vars/proxmox/secrets.sops.yaml.

  rescue:
    - name: Display root password after SOPS write failure
      ansible.builtin.debug:
        msg: >-
          WARNING: Failed to encrypt/write secrets file.
          Save this password -- it cannot be recovered:
          {{ _proxmox_base_root_password_value }}

    - name: Fail after displaying root password
      ansible.builtin.fail:
        msg: >-
          SOPS persistence failed. The password was displayed above.
          Save it manually: add 'proxmox_root_password' and
          'proxmox_root_password_hash' to
          inventory/group_vars/proxmox/secrets.sops.yaml and run:
          sops --encrypt --in-place inventory/group_vars/proxmox/secrets.sops.yaml

# Phase 2: Apply (always, when password hash is available)

- name: Set root password
  ansible.builtin.user:
    name: root
    password: "{{ _proxmox_base_root_password_hash_value | default(proxmox_root_password_hash) }}"
  no_log: true
  when: _proxmox_base_root_password_hash_value is defined or proxmox_root_password_hash is defined
